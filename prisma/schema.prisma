// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  OWNER
  SUPERADMIN  // Para acceso OCR y funciones avanzadas
}

enum OrderMode {
  SALON       // Pedido en mesa (presencial)
  DELIVERY    // Pedido para envío a domicilio
  TAKEAWAY    // Retiro en local (futuro)
}

enum OrderStatus {
  PENDING     // Cliente armando pedido
  CONFIRMED   // Cliente confirmó, esperando cocina
  PREPARING   // En cocina
  READY       // Listo para servir/enviar
  DELIVERED   // Entregado/Servido
  CANCELLED   // Cancelado
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  password       String
  restaurantId   String   @unique
  restaurantName String
  phone          String?
  address        String?
  plan           String?  @default("basic")
  role           Role     @default(ADMIN)
  avatar         String?
  isActive       Boolean  @default(true)
  lastLogin      DateTime?
  
  // WhatsApp configuration
  whatsappPhone       String?
  whatsappToken       String?
  whatsappPhoneId     String?
  whatsappEnabled     Boolean @default(false)
  
  // Relations
  menus          Menu[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("users")
}

model Menu {
  id             String   @id @default(cuid())
  restaurantId   String   @unique
  restaurantName String
  description    String?
  
  // Logo
  logoUrl        String?
  logoPublicId   String?
  
  // Theme configuration
  primaryColor     String @default("#2563eb")
  secondaryColor   String @default("#64748b")
  backgroundColor  String @default("#ffffff")
  textColor        String @default("#1f2937")
  fontFamily       String @default("Inter")
  
  // Contact information
  contactPhone     String?
  contactEmail     String?
  contactAddress   String?
  contactWebsite   String?
  socialInstagram  String?
  socialFacebook   String?
  socialTwitter    String?
  
  // Settings
  showPrices       Boolean @default(true)
  showImages       Boolean @default(true)
  showDescriptions Boolean @default(true)
  showNutritional  Boolean @default(false)
  allowOrdering    Boolean @default(false)
  currency         String  @default("$")
  language         String  @default("es")
  
  // Delivery configuration
  deliveryEnabled  Boolean @default(false)
  deliveryFee      Float   @default(0)
  deliveryRadius   Float?  // km (opcional)
  deliveryMinOrder Float?  // Mínimo para delivery (opcional)
  
  isActive       Boolean  @default(true)
  
  // Relations
  owner          User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId        String
  categories     Category[]
  items          MenuItem[]
  orders         Order[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("menus")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  position    Int      @default(0)
  isActive    Boolean  @default(true)
  code        String?  @unique // Código único para la categoría (ej: "01", "02", "03")
  
  // Image
  imageUrl    String?
  imagePublicId String?
  
  // Relations
  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId      String
  items       MenuItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("categories")
}

model MenuItem {
  id              String   @id @default(cuid())
  name            String
  description     String?
  price           Float
  originalPrice   Float?
  position        Int      @default(0)
  code            String?  // Código del plato (ej: "0101", "0302", "0401")
  
  // Images (VALOR AGREGADO COMERCIAL)
  imageUrl        String?  // URL principal
  imagePublicId   String?  // Para Cloudinary
  galleryImages   String?  // JSON array de URLs adicionales
  hasImage        Boolean  @default(false) // Para filtros rápidos
  
  // Status and features (simplificado)
  isAvailable     Boolean  @default(true)
  isPopular       Boolean  @default(false)
  isPromo         Boolean  @default(false) // Para PROMOS destacadas
  spicyLevel      Int      @default(0) // 0-3 scale
  
  // Commercial info (lo que realmente importa)
  preparationTime Int?     // in minutes
  tags            String?  // "PROMO,POPULAR,NUEVO" etc
  
  // Relations
  menu            Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId          String
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId      String
  orderItems      OrderItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("menu_items")
}

model Order {
  id              String       @id @default(cuid())
  orderNumber     Int          // Número correlativo por día (ej: 1, 2, 3...)
  
  // CONTEXTO
  mode            OrderMode    // SALON o DELIVERY
  status          OrderStatus  @default(PENDING)
  
  // IDENTIFICACIÓN CLIENTE/MESA
  tableNumber     String?      // Solo si mode=SALON ("Mesa 12")
  customerName    String?      // Obligatorio si mode=DELIVERY
  customerPhone   String?      // Obligatorio si mode=DELIVERY
  customerAddress String?      // Obligatorio si mode=DELIVERY
  deliveryNotes   String?      // "Timbre 3B", "Casa azul", etc.
  customerNotes   String?      // Observaciones generales del cliente (ej: "Sin sal", "Tocar timbre negro")
  
  // DATOS DEL RESTAURANTE
  restaurantId    String       // A qué comercio pertenece
  menu            Menu         @relation(fields: [menuId], references: [id])
  menuId          String
  
  // ITEMS DEL PEDIDO
  items           OrderItem[]  // Relación con items
  
  // TOTALES
  subtotal        Float        // Suma de items
  deliveryFee     Float        @default(0) // Solo si mode=DELIVERY
  total           Float        // subtotal + deliveryFee
  
  // METADATA
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  confirmedAt     DateTime?    // Cuando cliente apretó "Confirmar"
  completedAt     DateTime?    // Cuando se marcó DELIVERED
  
  // WHATSAPP (opcional)
  whatsappSent    Boolean      @default(false)
  whatsappMessage String?      // Mensaje generado automáticamente
  
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  
  // RELACIÓN CON PEDIDO
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     String
  
  // DATOS DEL PRODUCTO (snapshot al momento del pedido)
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId  String
  itemName    String   // Guardamos nombre por si cambia el menú
  itemPrice   Float    // Guardamos precio al momento del pedido
  
  // CANTIDAD Y TOTAL
  quantity    Int      @default(1)
  subtotal    Float    // quantity * itemPrice
  
  // PERSONALIZACIONES (opcional futuro)
  notes       String?  // "Sin cebolla", "Bien cocido", etc.
  
  createdAt   DateTime @default(now())
  
  @@map("order_items")
}